tinymce.PluginManager.add("cms_ad",function(editor,url){var shortcode=/\[([^:]+):([^:\]]+)\]/g;function getAttr(s,n){return(n=new RegExp(n+'="([^"]+)"',"g").exec(s))?window.decodeURIComponent(n[1]):""}function replaceShortcodes(content){return content.replace(shortcode,function(match,p1,p2){return'<p><img src="'+url+"/../img/"+(shortcode=p1)+'.png"  class="mceItem mceAdShortcode mceAdShortcode'+(type=p2)+'" data-shortcode="'+shortcode+'" data-shortcode-type="'+type+'" data-mce-resize="false" data-mce-placeholder="1"></p>';var shortcode,type})}editor.on("BeforeSetContent",function(event){-1!==event.content.search(shortcode)&&(event.content=replaceShortcodes(event.content))}),editor.on("ResolveName",function(event){var dom=editor.dom,node=event.target;"IMG"===node.nodeName&&dom.getAttrib(node,"data-shortcode")&&dom.hasClass(node,"mceAdShortcode")&&(event.name="cms_ad")}),editor.on("PostProcess",function(event){event.get&&(event.content=event.content.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(match,image){var shortcode=getAttr(image,"data-shortcode");return shortcode?"["+shortcode+":"+getAttr(image,"data-shortcode-type")+"]":match}))}),editor.addButton("cms_ad",{title:"Insert Ad Shortcode",cmd:"cms_ad",image:url+"/../img/tinymce-icon.png"}),editor.addCommand("cms_ad",function(){var result=prompt("Enter the ad code to insert");result&&0!==result.length&&editor.execCommand("mceReplaceContent",!1,"[cms_ad:"+result+"]")})});